generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  role      Role       @default(USER)
  active    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  guideId   String?    @unique
  auditLogs AuditLog[]
  invites   Invite[]
  trips     Trip[]     @relation("UserTrips")
  guide     Guide?     @relation(fields: [guideId], references: [id])
}

model Invite {
  id          String       @id @default(cuid())
  email       String       @unique
  invitedById String
  acceptedAt  DateTime?
  status      InviteStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  invitedBy   User         @relation(fields: [invitedById], references: [id])
}

model Guide {
  id         String      @id @default(cuid())
  name       String
  rank       GuideRank
  active     Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  email      String?     @unique
  ledTrips   Trip[]      @relation("TripLeader")
  tripGuides TripGuide[]
  user       User?
}

model FeeRate {
  id       String    @id @default(cuid())
  rank     GuideRank
  rateType RateType  @default(PER_TRIP)
  amount   Decimal   @db.Decimal(10, 2)

  @@unique([rank, rateType], name: "rank_rateType")
}

model Trip {
  id              String            @id @default(cuid())
  tripDate        DateTime
  status          TripStatus        @default(DRAFT)
  leadName        String
  paxGuideNote    String?
  totalPax        Int
  paymentsMadeYN  Boolean           @default(false)
  picsUploadedYN  Boolean           @default(false)
  tripEmailSentYN Boolean           @default(false)
  createdById     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  suggestions     String?
  tripReport      String?
  tripLeaderId    String?
  discounts       DiscountLine[]
  payments        PaymentBreakdown?
  createdBy       User              @relation("UserTrips", fields: [createdById], references: [id])
  tripLeader      Guide?            @relation("TripLeader", fields: [tripLeaderId], references: [id])
  guides          TripGuide[]
}

model TripGuide {
  id        String  @id @default(cuid())
  tripId    String
  guideId   String
  paxCount  Int     @default(0)
  feeAmount Decimal @db.Decimal(10, 2)
  guide     Guide   @relation(fields: [guideId], references: [id])
  trip      Trip    @relation(fields: [tripId], references: [id])
}

model PaymentBreakdown {
  id                 String  @id @default(cuid())
  tripId             String  @unique
  cashReceived       Decimal @db.Decimal(10, 2)
  creditCards        Decimal @db.Decimal(10, 2)
  onlineEFTs         Decimal @db.Decimal(10, 2)
  vouchers           Decimal @db.Decimal(10, 2)
  members            Decimal @db.Decimal(10, 2)
  agentsToInvoice    Decimal @db.Decimal(10, 2)
  discountsTotal     Decimal @db.Decimal(10, 2)
  waterPhoneSunblock Decimal @default(0) @db.Decimal(10, 2)
  trip               Trip    @relation(fields: [tripId], references: [id])
}

model DiscountLine {
  id     String  @id @default(cuid())
  tripId String
  amount Decimal @db.Decimal(10, 2)
  reason String
  trip   Trip    @relation(fields: [tripId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  action      String
  beforeJSON  Json?
  afterJSON   Json?
  actorUserId String
  createdAt   DateTime @default(now())
  actor       User     @relation(fields: [actorUserId], references: [id])
}

model Setting {
  id              String @id @default(cuid())
  timezone        String @default("Africa/Johannesburg")
  currency        String @default("ZAR")
  emailDayOfMonth Int    @default(29)
  emailHourLocal  Int    @default(8)
  brandPrimary    String @default("#0A66C2")
  brandAccent     String @default("#0B84F3")
}

enum Role {
  ADMIN
  USER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
}

enum GuideRank {
  SENIOR
  INTERMEDIATE
  JUNIOR
  TRAINEE
}

enum RateType {
  PER_TRIP
  PER_PAX
}

enum TripStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  LOCKED
}
